<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Cleaner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #030331;
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            background-color: #ffffff;
            color: #030331;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
        }
        input, button {
            margin: 10px 0;
            padding: 10px;
        }
        button {
            background-color: #030331;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Excel Report Cleaner</h1>
        <p>Upload a TDBL or ITH report to clean the data automatically.</p>
        <input type="file" id="fileInput" accept=".xlsx, .xls">
        <button onclick="processFile()">Clean File</button>
        <div id="errorMessage" style="color: red; margin-top: 10px;"></div>
    </div>

    <script>
        function processFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) {
                showError("Please upload a file first.");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
                    const sheetName = workbook.SheetNames[0];
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: "" });

                    const reportType = detectReportType(jsonData);
                    const cleanedData = reportType === "TDBL" ? cleanTDBL(jsonData) : cleanITH(jsonData);

                    downloadCleanedFile(cleanedData, file.name);
                } catch (error) {
                    showError("Error processing file: " + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function detectReportType(data) {
            return data.some(row => "Count Ridership" in row) ? "TDBL" : "ITH";
        }

        function cleanTDBL(data) {
            let cleanedData = data.slice(5, -1); // Remove first 5 rows and last row

            cleanedData = cleanedData.filter(row => row.Status !== "Declined" && row.Status !== "Orphan Declined");
            cleanedData.forEach(row => {
                row.Mode = mapMode(row.Mode);
                row["Entry Date"] = formatDate(row["Entry Date"]);
            });

            return cleanedData.map(row => ({
                "Entry Date": row["Entry Date"] || "",
                "Mode": row.Mode || "",
                "Media Row ID": row["Media Row ID"] || "",
                "Product Type": row["Product Type"] || "",
                "Count Ridership": row["Count Ridership"] || ""
            }));
        }

        function cleanITH(data) {
            let cleanedData = data.slice(5, -6); // Remove first 5 rows and last 6 rows

            cleanedData = cleanedData.filter(row => row.Status !== "Declined" && row.Status !== "Orphan Declined");
            cleanedData.forEach(row => {
                row.Mode = mapMode(row.Mode);
                row["Entry Date"] = formatDate(row["Entry Date"]);
                row["Count Ridership"] = mapCountRidership(row["Transaction Type"]);
            });

            return cleanedData.map(row => ({
                "Entry Date": row["Entry Date"] || "",
                "Mode": row.Mode || "",
                "Media Row ID": row["Media Row ID"] || "",
                "Product Type": row["Product Type"] || "",
                "Count Ridership": row["Count Ridership"] || ""
            }));
        }

        function mapMode(mode) {
            if (mode === "Commuter Rail") return "Rail";
            if (mode === "CCT" || mode === "Paratransit") return "CCT";
            return "Transit";
        }

        function mapCountRidership(transactionType) {
            if (transactionType === "C" || transactionType === "D") return 0;
            if (transactionType === "R") return -1;
            return 1;
        }

        function formatDate(entryDate) {
            if (!entryDate) return "";
            return entryDate.split(" ")[0];
        }

        function downloadCleanedFile(data, originalFileName) {
            const workbook = XLSX.utils.book_new();
            const sheet = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(workbook, sheet, "Cleaned Data");

            const newFileName = originalFileName.replace(/\.[^/.]+$/, "") + " - Cleaned.xlsx";
            XLSX.writeFile(workbook, newFileName);
        }

        function showError(message) {
            document.getElementById("errorMessage").innerText = message;
        }
    </script>
</body>
</html>
