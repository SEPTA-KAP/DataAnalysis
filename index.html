<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background-color: #030331;
            font-family: 'Meriweather', serif;
            overflow-y: scroll;
        }
        
        .container {
            background-color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: visible;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        
        .primary-btn {
            background-color: #030331;
            color: white;
        }
        
        button:hover {
            background-color: #294d5a;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #030331;
            border-radius: 4px;
        }

        #preview {
            margin-top: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #030331;
            color: white;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }

        .success {
            background-color: #dff0d8;
            color: #030331;
        }

        .error {
            background-color: #f2dede;
            color: #a94442;
        }

        #debugOutput {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>KAP Data Cleaner</h2>
        <p>This program processes raw ridership reports to further create matrices below.
            If you intend to create matrices, ensure you filter out unwanted product types and unwanted/extra dates included by Crystal Reports before uploading into a matrix generator.
        </p>
        
        <div class="input-group">
            <label for="fileInput">Select Excel File:</label>
            <input type="file" id="fileInput" accept=".xlsx,.xls">
        </div>
        
        <div class="input-group">
            <label for="sheetSelect">Select Sheet:</label>
            <select id="sheetSelect"></select>
        </div>
        
        <button class="primary-btn" onclick="processFile()">Process File</button>
        
        <div id="status" class="status"></div>
        <div id="debugOutput"></div>
        <div id="preview"></div>
    </div>
    
    <div class="container">
        <h1>Mode Matrix Generator</h1>
        <div class="instructions">
            <p>This tool takes cleaned ridership data and breaks down transit, rail, and CCT trips by unique Media Row ID.
                Ensure your data is cleaned before uploading. If you're not sure, check for "-Cleaned data" at the end of your file name.</p>
            
        </div>
        <div class="error" id="errorMessage"></div>
        <input type="file" id="fileInput" accept=".xlsx,.xls" required>
        <button class= "primary-btn" onclick= "processFile()" >Generate Matrix</button>
    </div>

    <script>
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function createPivotTable(data) {
            // Check required columns
            const requiredColumns = ['Mode', 'Media Row ID', 'Count Ridership'];
            const headers = Object.keys(data[0]);
            
            if (!requiredColumns.every(col => headers.includes(col))) {
                throw new Error('Required columns missing. Please ensure your file has: Mode, Media Row ID, and Count Ridership columns.');
            }

            // Create pivot table structure
            const pivot = {};
            const modes = new Set();

            // First pass: collect all modes and create basic structure
            data.forEach(row => {
                const mediaRowId = row['Media Row ID'];
                const mode = row['Mode'];
                const count = Number(row['Count Ridership']) || 0;

                modes.add(mode);
                
                if (!pivot[mediaRowId]) {
                    pivot[mediaRowId] = {};
                }
                
                if (!pivot[mediaRowId][mode]) {
                    pivot[mediaRowId][mode] = 0;
                }
                
                pivot[mediaRowId][mode] += count;
            });

            // Convert to array format and add totals
            const modesArray = Array.from(modes);
            const resultArray = Object.entries(pivot).map(([mediaRowId, modeData]) => {
                const row = {
                    'Media Row ID': mediaRowId
                };

                // Fill in all modes (including zeros for missing data)
                modesArray.forEach(mode => {
                    row[mode] = modeData[mode] || 0;
                });

                // Calculate total (sum of Transit and Rail if they exist)
                row['Total'] = (row['Transit'] || 0) + (row['Rail'] || 0);

                return row;
            });

            // Add grand total row
            const grandTotal = {
                'Media Row ID': 'Grand Total'
            };
            
            modesArray.forEach(mode => {
                grandTotal[mode] = resultArray.reduce((sum, row) => sum + (row[mode] || 0), 0);
            });
            
            grandTotal['Total'] = (grandTotal['Transit'] || 0) + (grandTotal['Rail'] || 0);
            
            resultArray.push(grandTotal);

            return resultArray;
        }

        function processFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('Please select a file first!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get first sheet
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    // Create pivot table
                    const processedData = createPivotTable(jsonData);
                    
                    // Create new workbook
                    const newWorkbook = XLSX.utils.book_new();
                    const newSheet = XLSX.utils.json_to_sheet(processedData);

                    // Auto-size columns
                    const maxWidths = {};
                    processedData.forEach(row => {
                        Object.entries(row).forEach(([key, value]) => {
                            const valueLength = String(value).length;
                            maxWidths[key] = Math.max(maxWidths[key] || 0, valueLength, key.length);
                        });
                    });

                    // Apply column widths
                    const ws_cols = Object.entries(maxWidths).map(([key, width]) => ({
                        wch: width + 2
                    }));
                    newSheet['!cols'] = ws_cols;
                    
                    XLSX.utils.book_append_sheet(newWorkbook, newSheet, 'Mode Matrix');
                    
                    // Generate filename based on original filename
                    const baseName = file.name.replace(/\.[^/.]+$/, "");
                    const newFileName = `${baseName} - Mode Matrix.xlsx`;
                    
                    // Download file
                    XLSX.writeFile(newWorkbook, newFileName);
                } catch (error) {
                    showError('Error processing file: ' + error.message);
                }
            };
            
            reader.onerror = function(error) {
                showError('Error reading file: ' + error.message);
            };
            
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
