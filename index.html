<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAP Data Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Meriweather', serif;
            background-color: #030331;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background-color: #e9ecef;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .tab.active {
            background-color: #030331;
            color: rgb(255, 255, 255);
        }
        .generator {
            display: none;
            padding: 20px;
            border: 1px solid #ffffff;
            border-radius: 5px;
        }
        .generator.active {
            display: block;
        }
        .error {
            color: #dc3545;
            margin: 10px 0;
            display: none;
        }
        input[type="file"] {
            margin: 20px 0;
            width: 100%;
            max-width: 300px;
        }
        button {
            padding: 10px 20px;
            background-color: #030331;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #030331;
        }
        .instructions {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .instructions h3 {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>KAP Data Analysis</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showGenerator('cleaner')">Data Cleaner</button>
            <button class="tab" onclick="showGenerator('matrix')">Mode Matrix Generator</button>
        </div>

        <div id="cleaner" class="generator active">
            <div class="instructions">
                <h3>Data Cleaner</h3>
                <p>This tool is used to clean 'Crystal Reports' ridership summaries to further create matrices. It is important that the user leaves the raw ridership report as it is before uploading. The only
                    action needed before or after uploading is removing unwanted rows from the raw ridership report.  </p>
                <p>Crystal Reports often includes more data than requested. A ridership report meant to start on November 1st will almost always include data from the prior October. Delete unwanted rows.</p>
            </div>
            <div class="error" id="cleanerError"></div>
            <input type="file" id="cleanerInput" accept=".xlsx,.xls" required>
            <button onclick="cleanData()">Clean Data</button>
        </div>

        <div id="matrix" class="generator">
            <div class="instructions">
                <h3>Mode Matrix Generator</h3>
                <p>This tool takes cleaned ridership data and breaks down transit, rail, and CCT trips by unique Media Row ID.
                    Ensure your data is cleaned before uploading. If you're not sure, check for "-Cleaned data" at the end of your file name.
                </p>
                
                </ul>
            </div>
            <div class="error" id="matrixError"></div>
            <input type="file" id="matrixInput" accept=".xlsx,.xls" required>
            <button onclick="generateMatrix()">Generate Matrix</button>
        </div>
    </div>

    <script>
        function showGenerator(id) {
            // Hide all generators
            document.querySelectorAll('.generator').forEach(gen => gen.style.display = 'none');
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected generator
            document.getElementById(id).style.display = 'block';
            document.querySelector(`[onclick="showGenerator('${id}')"]`).classList.add('active');
        }

        function showError(id, message) {
            const errorDiv = document.getElementById(id);
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function cleanData() {
            const fileInput = document.getElementById('cleanerInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('cleanerError', 'Please select a file first!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    let jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    // Remove first 5 rows
                    jsonData = jsonData.slice(5);

                    // Set headers and remove header row
                    const headers = jsonData[0].map(h => String(h).trim());
                    jsonData = jsonData.slice(1);

                    // Convert to array of objects
                    const processedData = jsonData.map(row => {
                        const obj = {};
                        headers.forEach((header, i) => {
                            obj[header] = row[i];
                        });
                        return obj;
                    });

                    // Filter out declined status
                    const filteredData = processedData.filter(row => 
                        !['Declined', 'Orphan Declined'].includes(row['Status']));

                    // Process Mode column
                    filteredData.forEach(row => {
                        if (row['Mode']) {
                            if (row['Mode'] === 'Commuter Rail') row['Mode'] = 'Rail';
                            else if (['CCT', 'Paratransit'].includes(row['Mode'])) row['Mode'] = 'CCT';
                            else row['Mode'] = 'Transit';
                        }
                    });

                    // Process dates and create Count Ridership
                    filteredData.forEach(row => {
                        if (row['Entry Date']) {
                            const date = new Date(row['Entry Date']);
                            row['Entry Date'] = date.toLocaleDateString('en-US');
                        }
                        if (!row['Count Ridership'] && row['Transaction Type']) {
                            row['Count Ridership'] = 
                                ['C', 'D'].includes(row['Transaction Type']) ? 0 :
                                row['Transaction Type'] === 'R' ? -1 : 1;
                        }
                    });

                    // Create new workbook with processed data
                    const newWorkbook = XLSX.utils.book_new();
                    const newSheet = XLSX.utils.json_to_sheet(filteredData);
                    XLSX.utils.book_append_sheet(newWorkbook, newSheet, 'Cleaned Data');

                    // Generate filename
                    const baseName = file.name.replace(/\.[^/.]+$/, "");
                    const newFileName = `${baseName} - Cleaned Data.xlsx`;

                    // Save file
                    XLSX.writeFile(newWorkbook, newFileName);
                } catch (error) {
                    showError('cleanerError', 'Error processing file: ' + error.message);
                }
            };
            
            reader.onerror = function(error) {
                showError('cleanerError', 'Error reading file: ' + error.message);
            };
            
            reader.readAsArrayBuffer(file);
        }

        function generateMatrix() {
            // [Previous matrix generation code remains the same]
            const fileInput = document.getElementById('matrixInput');
            // ... [rest of your existing matrix generation code]
        }
    </script>
</body>
</html>
