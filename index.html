<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAP Data Processing Tools</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Meriweather', serif;
            background-color: #030331;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background-color: #ffffff;
            padding: 48px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin: 20px 0;
            width: 90%;
            max-width: 800px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #030331;
            border-radius: 4px;
        }
        button {
            background-color: #030331;
            color: rgb(255, 255, 255);
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover {
            background-color: #356083;
        }
        #preview {
            margin-top: 20px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #030331;
            color: white;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #dff0d8;
            color: #030331;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
        }
        #debugOutput {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .instructions {
            text-align: left;
            margin: 20px 0;
            font-size: 14px;
            color: #030331;
        }
    </style>
</head>
<body>
    <!-- Data Cleaner Container -->
    <div class="container">
        <h1>KAP Data Cleaner</h1>
        <p>This program processes raw ridership reports to further create matrices below.
            If you intend to create matrices, ensure you filter out unwanted product types and unwanted/extra dates included by Crystal Reports before uploading into a matrix generator.
        </p>
        
        <div class="input-group">
            <label for="fileInput">Select Excel File:</label>
            <input type="file" id="fileInput" accept=".xlsx,.xls">
        </div>
        
        <div class="input-group">
            <label for="sheetSelect">Select Sheet:</label>
            <select id="sheetSelect"></select>
        </div>
        
        <button onclick="processFile()">Process File</button>
        
        <div id="status" class="status"></div>
        <div id="debugOutput"></div>
        <div id="preview"></div>
    </div>

    <!-- Mode Matrix Generator Container -->
    <div class="container">
        <h1>Mode Matrix Generator</h1>
        <div class="instructions">
            <p>This tool takes cleaned ridership data and breaks down transit, rail, and CCT trips by unique Media Row ID.
                Ensure your data is cleaned before uploading. If you're not sure, check for "-Cleaned data" at the end of your file name.</p>
        </div>
        <div class="error" id="errorMessage"></div>
        <input type="file" id="matrixFileInput" accept=".xlsx,.xls" required>
        <button onclick="processMatrixFile()">Generate Matrix</button>
    </div>

    <script>
        // Data Cleaner Script
        let workbook = null;

        function debug(message) {
            console.log(message);
            const debugOutput = document.getElementById('debugOutput');
            debugOutput.textContent += message + '\n';
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            debug(`File selected: ${file.name}`);
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    debug('Reading file...');
                    workbook = XLSX.read(e.target.result, { type: 'array' });
                    debug(`File read successfully. Sheets found: ${workbook.SheetNames.join(', ')}`);
                    updateSheetList();
                } catch (error) {
                    debug(`Error reading file: ${error.message}`);
                    showStatus('Error reading file: ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        });

        function updateSheetList() {
            const sheetSelect = document.getElementById('sheetSelect');
            sheetSelect.innerHTML = '';
            
            workbook.SheetNames.forEach(sheetName => {
                const option = document.createElement('option');
                option.value = sheetName;
                option.textContent = sheetName;
                sheetSelect.appendChild(option);
            });
            debug('Sheet list updated');
        }

        function processFile() {
            debug('Starting file processing...');
            document.getElementById('debugOutput').textContent = '';
            
            try {
                if (!workbook) {
                    throw new Error('Please select a file first.');
                }

                const sheetName = document.getElementById('sheetSelect').value;
                debug(`Processing sheet: ${sheetName}`);
                
                const worksheet = workbook.Sheets[sheetName];
                let df = XLSX.utils.sheet_to_json(worksheet, { 
                    header: 1,
                    raw: false,
                    range: 5
                });
                
                const headers = df[0].map(h => h ? String(h).trim() : '');
                debug(`Headers found: ${headers.join(', ')}`);
                
                df = df.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((header, i) => {
                        if (header && row[i] !== undefined) {
                            obj[header] = row[i];
                        }
                    });
                    return obj;
                });

                df = df.filter(row => Object.keys(row).length > 0);
                debug(`After removing empty rows: ${df.length} rows`);

                const hasCountRidership = headers.includes('Count Ridership');
                df = hasCountRidership ? df.slice(0, -1) : df.slice(0, -6);

                const beforeFilter = df.length;
                df = df.filter(row => !['Declined', 'Orphan Declined'].includes(row['Status']));
                debug(`Filtered out ${beforeFilter - df.length} declined status rows`);

                df = df.map(row => {
                    const { Status, ...rest } = row;
                    return rest;
                });

                df = df.map(row => ({
                    ...row,
                    Mode: row.Mode === 'Commuter Rail' ? 'Rail' : 
                          (row.Mode === 'CCT' || row.Mode === 'Paratransit') ? 'CCT' : 'Transit'
                }));

                df = df.map(row => ({
                    ...row,
                    'Entry Date': row['Entry Date'] ? new Date(row['Entry Date']).toLocaleDateString() : ''
                }));

                if (hasCountRidership) {
                    df = df.map(row => {
                        const { 'Transaction Type': _, ...rest } = row;
                        return rest;
                    });
                    debug('Removed Transaction Type column as Count Ridership exists');
                } else {
                    df = df.map(row => {
                        let countRidership;
                        if (row['Transaction Type'] === 'R') {
                            countRidership = '(1)';
                        } else if (row['Transaction Type'] === 'C' || row['Transaction Type'] === 'D') {
                            countRidership = '0';
                        } else {
                            countRidership = '1';
                        }
                        
                        const { 'Transaction Type': _, ...rest } = row;
                        return {
                            ...rest,
                            'Count Ridership': countRidership
                        };
                    });
                    debug('Created Count Ridership column from Transaction Type');
                }

                const requiredColumns = ['Entry Date', 'Mode', 'Media Row ID', 'Product Type', 'Count Ridership'];
                df = df.map(row => {
                    const newRow = {};
                    requiredColumns.forEach(col => {
                        if (col in row) {
                            newRow[col] = row[col] || '';
                        } else {
                            newRow[col] = '';
                        }
                    });
                    return newRow;
                });

                debug(`Final columns: ${Object.keys(df[0] || {}).join(', ')}`);

                const newWorkbook = XLSX.utils.book_new();
                const newWorksheet = XLSX.utils.json_to_sheet(df);
                XLSX.utils.book_append_sheet(newWorkbook, newWorksheet, sheetName);

                const fileName = document.getElementById('fileInput').files[0].name;
                const newFileName = fileName.replace(/\.[^/.]+$/, '') + ' - Cleaned Data.xlsx';
                debug(`Saving to file: ${newFileName}`);
                XLSX.writeFile(newWorkbook, newFileName);

                showPreview(df);
                showStatus('File processed successfully! Download should begin automatically.', 'success');
                debug('Processing complete');

            } catch (error) {
                debug(`Error during processing: ${error.message}`);
                showStatus(`Error processing file: ${error.message}`, 'error');
            }
        }

        function showPreview(data) {
            try {
                const preview = document.getElementById('preview');
                if (!data || data.length === 0) {
                    preview.innerHTML = '<p>No data to display</p>';
                    return;
                }

                const headers = Object.keys(data[0] || {});
                let table = '<table><tr>';
                headers.forEach(header => {
                    table += `<th>${header}</th>`;
                });
                table += '</tr>';

                data.slice(0, 10).forEach(row => {
                    table += '<tr>';
                    headers.forEach(header => {
                        table += `<td>${row[header] || ''}</td>`;
                    });
                    table += '</tr>';
                });
                table += '</table>';

                preview.innerHTML = '<h3>Preview (First 10 rows)</h3>' + table;
                debug('Preview table generated');
            } catch (error) {
                debug(`Error generating preview: ${error.message}`);
            }
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            debug(`Status: ${message}`);
        }

        // Mode Matrix Generator Script
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function createPivotTable(data) {
            const requiredColumns = ['Mode', 'Media Row ID', 'Count Ridership'];
            const headers = Object.keys(data[0]);
            
            if (!requiredColumns.every(col => headers.includes(col))) {
                throw new Error('Required columns missing. Please ensure your file has: Mode, Media Row ID, and Count Ridership columns.');
            }

            const pivot = {};
            const modes = new Set();

            data.forEach(row => {
                const mediaRowId = row['Media Row ID'];
                const mode = row['Mode'];
                const count = Number(row['Count Ridership']) || 0;

                modes.add(mode);
                
                if (!pivot[mediaRowId]) {
                    pivot[mediaRowId] = {};
                }
                
                if (!pivot[mediaRowId][mode]) {
                    pivot[mediaRowId][mode] = 0;
                }
                
                pivot[mediaRowId][mode] += count;
            });

            const modesArray = Array.from(modes);
            const resultArray = Object.entries(pivot).map(([mediaRowId, modeData]) => {
                const row = {
                    'Media Row ID': mediaRowId
                };

                modesArray.forEach(mode => {
                    row[mode] = modeData[mode] || 0;
                });

                row['Total'] = (row['Transit'] || 0) + (row['Rail'] || 0);

                return row;
            });

            const grandTotal = {
                'Media Row ID': 'Grand Total'
            };
            
            modesArray.forEach(mode => {
                grandTotal[mode] = resultArray.reduce((sum, row) => sum + (row[mode] || 0), 0);
            });
            
            grandTotal['Total'] = (grandTotal['Transit'] || 0) + (grandTotal['Rail'] || 0);
            
            resultArray.push(grandTotal);

            return resultArray;
        }

        function processMatrixFile() {
            const fileInput = document.getElementById('matrixFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('Please select a file first!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    const processedData = createPivotTable(jsonData);
                    
                    const newWorkbook = XLSX.utils.book_new();
                    const newSheet = XLSX.utils.json_to_sheet(processedData);

                    const maxWidths = {};
                    processedData.forEach(row => {
                        Object.entries(row).forEach(([key, value]) => {
                            const valueLength = String(value).length;
                            maxWidths[key] = Math.max(maxWidths[key] ||
